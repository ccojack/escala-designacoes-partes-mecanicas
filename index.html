<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Escala - Novembro 2025 a Dezembro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #F3F4F6;
            color: #3D3D3D;
        }
        .highlight {
            background-color: #E0F5F6 !important;
            color: #0891B2 !important;
            font-weight: 600;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 450px;
        }

        /* --- ESTILOS DE IMPRESSÃO OTIMIZADOS PARA QUADRO DE AVISOS --- */
        @media print {
            /* 1. Global Print Settings */
            body {
                background-color: #fff !important;
                margin: 0;
                padding: 0;
                color: #000;
            }
            
            /* 2. Hide UI/Non-Print Elements */
            header, 
            footer, 
            #appContent, /* Filtros e escala pessoal */
            #sidebarContent, /* Gráfico e regras */
            button,
            .print\:hidden { 
                display: none !important;
            }

            /* 3. Focus on Printable Area (make it fill the page) */
            #printableArea {
                width: 100%;
                min-height: 100vh;
                margin: 0;
                padding: 20mm; /* Adiciona margem de segurança na página */
                box-shadow: none !important;
                border: none !important;
                background-color: #fff !important;
            }
            
            /* 4. Título Principal da Impressão */
            #printTitle {
                font-size: 24pt;
                font-weight: 800;
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 3px solid #000;
            }


            /* 5. Improve Table Readability for Printing */
            .overflow-x-auto {
                overflow: visible !important;
            }

            table {
                width: 100%;
                font-size: 11pt; /* Font size para leitura em quadro */
                border-collapse: collapse;
            }

            th, td {
                padding: 8px 6px;
                border: 1px solid #000; /* Borda preta para clareza */
                color: #000;
            }
            
            thead {
                background-color: #E5E7EB !important; 
                -webkit-print-color-adjust: exact; /* Força cores de fundo no cabeçalho */
                print-color-adjust: exact;
            }
            
            /* Ensure text is black and background is white for highlighted person */
            .highlight {
                background-color: #F3F4F6 !important; /* Subtle background for highlight */
                color: #000 !important;
                font-weight: bold;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Remove sombra e bordas arredondadas na impressão */
            th, td {
                border-radius: 0 !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 md:p-10">
        <header class="text-center mb-10 print:hidden">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">Painel de Escala de Atividades</h1>
            <p class="text-xl text-gray-500 mt-2">Novembro 2025 a Dezembro 2026: Visão Rápida e Personalizada</p>
        </header>

        <main>
            <div id="appContent"> <!-- Contém filtros e escala pessoal - será escondido na impressão -->
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-10 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-5 text-gray-700 border-b pb-3">Filtros Interativos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                        <div class="w-full">
                            <label for="monthFilter" class="block text-sm font-medium text-gray-600 mb-1">Mês:</label>
                            <select id="monthFilter" class="w-full p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-4 focus:ring-cyan-200 focus:border-cyan-600 transition duration-300 appearance-none bg-white">
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                        <div class="w-full">
                            <label for="personFilter" class="block text-sm font-medium text-gray-600 mb-1">Visualizar escala de:</label>
                            <select id="personFilter" class="w-full p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-4 focus:ring-cyan-200 focus:border-cyan-600 transition duration-300 appearance-none bg-white">
                                <option value="todos">Mostrar todos</option>
                            </select>
                        </div>
                        <div class="w-full">
                            <p class="block text-sm font-medium text-gray-600 mb-1">Filtrar por dia:</p>
                            <div id="dayFilterButtons" class="flex gap-2">
                                <button data-day="todos" class="flex-1 bg-cyan-600 text-white py-3 px-4 rounded-xl shadow-md hover:bg-cyan-700 transition duration-150 transform hover:scale-[1.01]">Todos</button>
                                <button data-day="QUARTA" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-xl shadow-sm hover:bg-gray-300 transition duration-150">Quartas</button>
                                <button data-day="SÁBADO" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-xl shadow-sm hover:bg-gray-300 transition duration-150">Sábados</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="personalSchedule" class="mb-10"></div>
            </div> <!-- Fim de appContent -->

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
                
                <div id="printableArea" class="xl:col-span-2 bg-white rounded-2xl shadow-xl p-4 md:p-8 border border-gray-100">
                    
                    <!-- NOVO TÍTULO DE IMPRESSÃO -->
                    <h1 id="printTitle" class="hidden print:block text-2xl font-extrabold text-gray-800">
                        ESCALA MENSAL DE ATIVIDADES: <span id="currentMonthDisplayPrint" class="text-cyan-700"></span>
                    </h1>
                    
                    <!-- Botão de impressão adicionado aqui -->
                    <div class="flex justify-between items-center border-b pb-3 mb-5 print:hidden">
                        <h2 class="text-2xl font-bold text-gray-700">Quadro de Escala Mensal Detalhado (<span id="currentMonthDisplay"></span>)</h2>
                        <button onclick="window.print()" class="bg-indigo-600 text-white py-2 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-150 flex items-center gap-2 text-sm font-semibold print:hidden">
                            <!-- Ícone de Impressora SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                            Imprimir Mês
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-base">
                            <thead class="bg-gray-100 text-gray-600 uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4 rounded-tl-xl">Data</th>
                                    <th class="p-4">Dia</th>
                                    <th class="p-4">Vídeo</th>
                                    <th class="p-4">Mesa de Som</th>
                                    <th class="p-4">Mic Volante</th>
                                    <th class="p-4">Palco</th>
                                    <th class="p-4">Ind. Auditório</th>
                                    <th class="p-4 rounded-tr-xl">Ind. Entrada</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="sidebarContent" class="space-y-10 print:hidden"> <!-- Contém gráfico e regras - será escondido na impressão -->
                    <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Distribuição de Carga de Trabalho Total</h2>
                         <p class="text-sm text-gray-500 mb-4">Total de escalas designadas no período (Nov/2025 - Dez/2026).</p>
                        <div class="chart-container">
                            <canvas id="workloadChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Regras e Restrições Chave</h2>
                        <ul class="list-disc list-inside space-y-3 text-gray-600 pl-3">
                            <li class="font-bold text-red-600">**Restrição Global:** Uma pessoa só pode ser escalada para **uma atividade por dia**.</li>
                            <li class="font-medium text-gray-700"><b>Filipe:</b> Não trabalha às Quartas-Feiras. (Restrição Mantida)</li>
                            <li class="font-medium text-gray-700"><b>Alexandre:</b> Restrição de Indicador (Auditório/Entrada) às Quartas-Feiras.</li>
                            <li class="font-medium text-gray-700"><b>4 Membros:</b> (Gonçalves, Alex, Gilson, José Maria) não trabalham em Mesa de Som ou Vídeo.</li>
                            <li class="font-medium text-gray-700"><b>Augusto:</b> Não trabalha em Vídeo, Mesa de Som ou Palco.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-16 py-6 border-t border-gray-300 print:hidden">
            <p class="text-gray-500 text-sm">Painel gerado em <span id="generationDate"></span> com foco em usabilidade e design responsivo.</p>
        </footer>
    </div>

    <script>
        const people = [
            'Fernando', 'Nikolas', 'Alexandre', 'Gilson', 'Henrique', 'Bruninho',
            'Bruno Fontes', 'Josivan', 'Gonçalves', 'Alex', 'Evandro', 'Leandro',
            'Roosevelt', 'José Maria', 'Filipe', 'Augusto'
        ];
        const activities = ['Vídeo', 'Mesa de Som', 'Microfone Volante', 'Palco', 'Indicador Auditório', 'Indicador Entrada'];
        const activityConstraints = {
            // Membros restritos em Vídeo e Mesa de Som (4 Membros)
            'Vídeo': ['Gilson', 'Gonçalves', 'Alex', 'José Maria', 'Augusto'], 
            'Mesa de Som': ['Gilson', 'Gonçalves', 'Alex', 'José Maria', 'Augusto'],
            // Augusto não trabalha no Palco
            'Palco': ['Augusto'],
        };
        const DAY_NAMES = ['DOMINGO', 'SEGUNDA', 'TERÇA', 'QUARTA', 'QUINTA', 'SEXTA', 'SÁBADO'];
        const MONTH_NAMES = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        
        let multiMonthScheduleData = {};
        let workloadChart;
        let currentFilters = { month: '', person: 'todos', day: 'todos' };

        // Função para formatar a string do mês/ano
        function formatMonthYear(month, year) {
            return `${MONTH_NAMES[month]} / ${year}`;
        }

        /**
         * Gera dados de escala para múltiplos meses, garantindo:
         * 1. Uma pessoa por dia em apenas uma atividade.
         * 2. Respeito a todas as restrições de exceção.
         * 3. Distribuição cíclica (fairness) ao longo do tempo.
         */
        function generateScheduleData() {
            const startDate = new Date(2025, 10, 1); // Nov 1, 2025 (Mês 10, pois 0=Jan)
            const endDate = new Date(2026, 11, 31); // Dec 31, 2026

            const schedule = {};
            
            // Usamos um array de índices para rastrear o ponto de partida do ciclo 
            // para CADA atividade, garantindo a distribuição justa (fairness).
            const activityIndices = activities.map(() => 0); 

            let currentDate = startDate;
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                
                // Procurar apenas Quartas (3) e Sábados (6)
                if (dayOfWeek === 3 || dayOfWeek === 6) {
                    const dia = DAY_NAMES[dayOfWeek];
                    const dateStr = `${String(currentDate.getDate()).padStart(2, '0')}/${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                    // Chave no formato YYYY/MM (Mês 0=Jan, 11=Dez)
                    const monthYearKey = `${currentDate.getFullYear()}/${String(currentDate.getMonth()).padStart(2, '0')}`;
                    
                    const shift = { data: dateStr, dia: dia };
                    const assignedPeopleToday = new Set(); // Conjunto para garantir a unicidade por dia

                    activities.forEach((activity, activityIndex) => {
                        let assignedPerson = null;
                        let attempts = 0;
                        
                        // Começa o ciclo a partir do último índice que esta atividade usou
                        let startIndex = activityIndices[activityIndex];
                        
                        // Tenta percorrer todas as pessoas para encontrar um candidato válido
                        while (attempts < people.length) { 
                            const personIndex = (startIndex + attempts) % people.length;
                            const currentPerson = people[personIndex];

                            // 1. RESTRIÇÃO: ÚNICA ATIVIDADE POR DIA
                            if (assignedPeopleToday.has(currentPerson)) {
                                attempts++;
                                continue; 
                            }

                            // 2. RESTRIÇÃO: Filipe não trabalha às Quartas
                            if (currentPerson === 'Filipe' && dia === 'QUARTA') {
                                attempts++;
                                continue; 
                            }

                            // 3. RESTRIÇÃO: Alexandre em Indicadores às Quartas
                            if (currentPerson === 'Alexandre' && dia === 'QUARTA' && activity.includes('Indicador')) {
                                attempts++;
                                continue;
                            }

                            // 4. RESTRIÇÃO: Membros restritos (Vídeo, Mesa de Som, Palco)
                            const isActivityRestricted = activityConstraints[activity] && activityConstraints[activity].includes(currentPerson);
                            if (isActivityRestricted) {
                                attempts++;
                                continue;
                            }
                            
                            // --- ATRIBUIÇÃO BEM-SUCEDIDA ---
                            assignedPerson = currentPerson;
                            assignedPeopleToday.add(assignedPerson); // Marca a pessoa como ocupada neste dia
                            shift[activity] = assignedPerson;
                            
                            // Atualiza o índice para onde o ciclo da atividade deve começar da próxima vez
                            activityIndices[activityIndex] = (personIndex + 1) % people.length; 
                            
                            break; // Sai do loop 'while'
                        }
                        
                        if (!assignedPerson) {
                            // Se não houver ninguém disponível (o que é improvável)
                            shift[activity] = 'VAZIO';
                        }
                    });

                    if (!schedule[monthYearKey]) {
                        schedule[monthYearKey] = [];
                    }
                    schedule[monthYearKey].push(shift);
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }
            return schedule;
        }

        document.addEventListener('DOMContentLoaded', () => {
            multiMonthScheduleData = generateScheduleData();
            
            populateMonthFilter();
            populatePersonFilter();
            
            const availableMonths = Object.keys(multiMonthScheduleData).sort();
            if (availableMonths.length === 0) return; // Se não houver dados, para aqui.

            const firstMonthKey = availableMonths[0]; // Nov/2025: "2025/10"
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-11
            const currentMonthKey = `${currentYear}/${String(currentMonth).padStart(2, '0')}`;
            
            // Lógica de Inicialização CORRIGIDA (garante Nov/2025 se fora da escala)
            if (multiMonthScheduleData[currentMonthKey]) {
                currentFilters.month = currentMonthKey;
            } else {
                // Se o mês atual não estiver no intervalo ou for anterior/posterior, força o primeiro mês.
                currentFilters.month = firstMonthKey; 
            }
            
            if (currentFilters.month) {
                document.getElementById('monthFilter').value = currentFilters.month;
            }
            
            renderAll();
            setupEventListeners();
            document.getElementById('generationDate').textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
        });

        function setupEventListeners() {
            document.getElementById('monthFilter').addEventListener('change', (e) => {
                currentFilters.month = e.target.value;
                renderAll();
            });

            document.getElementById('personFilter').addEventListener('change', (e) => {
                currentFilters.person = e.target.value;
                renderAll();
            });

            document.getElementById('dayFilterButtons').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentFilters.day = e.target.dataset.day;
                    document.querySelectorAll('#dayFilterButtons button').forEach(btn => {
                        btn.classList.remove('bg-cyan-600', 'text-white', 'transform', 'hover:scale-[1.01]', 'shadow-md');
                        btn.classList.add('bg-gray-200', 'text-gray-700', 'shadow-sm');
                    });
                    e.target.classList.add('bg-cyan-600', 'text-white', 'transform', 'hover:scale-[1.01]', 'shadow-md');
                    e.target.classList.remove('bg-gray-200', 'text-gray-700', 'shadow-sm');
                    renderAll();
                }
            });
        }
        
        function renderAll() {
            if (!currentFilters.month) return; 

            // CHRONOLOGICAL SORT FIX: Parsing YYYY/MM from the key
            const [year, monthIndexStr] = currentFilters.month.split('/');
            const monthIndex = parseInt(monthIndexStr);
            const formattedMonthYear = formatMonthYear(monthIndex, year);
            
            // Atualiza o display no app (hidden na impressão)
            document.getElementById('currentMonthDisplay').textContent = formattedMonthYear;
            // Atualiza o display no título de impressão (hidden no app)
            document.getElementById('currentMonthDisplayPrint').textContent = formattedMonthYear.toUpperCase();


            renderTable();
            renderPersonalSchedule();
            renderOrUpdateChart();
        }

        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            select.innerHTML = '';
            
            // The keys are now sorted correctly (YYYY/MM)
            const monthKeys = Object.keys(multiMonthScheduleData).sort();
            monthKeys.forEach(key => {
                // CHRONOLOGICAL SORT FIX: Parsing YYYY/MM from the key
                const [year, monthIndexStr] = key.split('/');
                const monthIndex = parseInt(monthIndexStr);
                const option = document.createElement('option');
                option.value = key;
                option.textContent = formatMonthYear(monthIndex, year);
                select.appendChild(option);
            });
        }

        function populatePersonFilter() {
            const select = document.getElementById('personFilter');
            people.sort().forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
        }

        function renderTable() {
            const tableBody = document.getElementById('scheduleTableBody');
            tableBody.innerHTML = '';
            
            const monthData = multiMonthScheduleData[currentFilters.month] || [];

            const filteredData = monthData.filter(row => {
                return currentFilters.day === 'todos' || row.dia === currentFilters.day;
            });

            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = `transition duration-100 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-cyan-50`;
                let rowHTML = `
                    <td class="p-4 font-medium">${row.data}</td>
                    <td class="p-4">${row.dia}</td>
                `;
                activities.forEach(activity => {
                    const person = row[activity];
                    const isHighlighted = person === currentFilters.person;
                    rowHTML += `<td class="p-4 ${isHighlighted ? 'highlight' : ''}">${person}</td>`;
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }

        function renderPersonalSchedule() {
            const container = document.getElementById('personalSchedule');
            if (currentFilters.person === 'todos') {
                container.innerHTML = '';
                return;
            }

            const personSchedule = (multiMonthScheduleData[currentFilters.month] || []).reduce((acc, row) => {
                activities.forEach(activity => {
                    if (row[activity] === currentFilters.person) {
                        acc.push({ date: row.data, day: row.dia, activity: activity });
                    }
                });
                return acc;
            }, []);

            if (personSchedule.length > 0) {
                 let scheduleHTML = `
                    <div class="bg-cyan-50 border-l-8 border-cyan-600 rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-cyan-800 mb-5">Sua Escala em ${document.getElementById('currentMonthDisplay').textContent}, ${currentFilters.person}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                `;

                personSchedule.forEach(shift => {
                    scheduleHTML += `
                        <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition duration-200">
                            <p class="font-extrabold text-gray-800 text-xl">${shift.date}</p>
                            <p class="text-gray-500">${shift.day}</p>
                            <p class="text-cyan-700 font-semibold mt-2">${shift.activity}</p>
                        </div>
                    `;
                });

                scheduleHTML += `</div></div>`;
                container.innerHTML = scheduleHTML;
            } else {
                 container.innerHTML = `
                    <div class="bg-yellow-50 border-l-8 border-yellow-600 rounded-xl shadow-lg p-6">
                         <h2 class="text-2xl font-bold text-yellow-800">${currentFilters.person} não tem escalas designadas neste mês.</h2>
                    </div>
                 `;
            }
        }

        // Calcula a carga de trabalho de TODO O PERÍODO
        function calculateWorkload() {
            const workload = {};
            people.forEach(p => workload[p] = 0);
            
            Object.values(multiMonthScheduleData).flat().forEach(row => {
                activities.forEach(activity => {
                    if (row[activity] && people.includes(row[activity])) {
                        workload[row[activity]]++;
                    }
                });
            });
            return Object.entries(workload).sort((a, b) => a[0].localeCompare(b[0]));
        }

        function renderOrUpdateChart() {
            const workloadData = calculateWorkload();
            const labels = workloadData.map(item => item[0]);
            const data = workloadData.map(item => item[1]);

            const ACCENT_COLOR = '#06B6D4'; // cyan-500
            const HIGHLIGHT_COLOR = '#0891B2'; // cyan-600
            
            const backgroundColors = labels.map(label => label === currentFilters.person ? HIGHLIGHT_COLOR : ACCENT_COLOR + '60');
            const borderColors = labels.map(label => label === currentFilters.person ? HIGHLIGHT_COLOR : ACCENT_COLOR);
            
            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Total de Escalas',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            };

            if (workloadChart) {
                workloadChart.data = chartData;
                workloadChart.update();
            } else {
                const ctx = document.getElementById('workloadChart').getContext('2d');
                workloadChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return ` Escalas: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    color: '#E5E7EB'
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
